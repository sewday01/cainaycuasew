from flask import Flask, render_template_string, request, send_from_directory, redirect, url_for
import yt_dlp
import os
import uuid
import concurrent.futures
import zipfile

app = Flask(__name__)
DOWNLOAD_FOLDER = "downloads"
os.makedirs(DOWNLOAD_FOLDER, exist_ok=True)

download_paused = False

HTML_TEMPLATE = '''
<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
  <meta charset="UTF-8">
  <title>Ngduc T√¢n (Sew) - T·∫£i Video</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class'
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Roboto', sans-serif; }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-gray-800 text-white min-h-screen flex flex-col items-center justify-center">
  <div class="bg-gray-700 rounded-2xl shadow-xl p-10 w-full max-w-xl">
    <h1 class="text-3xl font-bold text-cyan-300 text-center mb-6">
      ‚ú® Ngduc T√¢n (Sew) - Tr√¨nh T·∫£i Video ‚ú®
    </h1>
    {% if formats %}
      <div class="mb-4 text-sm">
        <p class="mb-2 font-semibold">ƒê·ªãnh d·∫°ng kh·∫£ d·ª•ng cho video ƒë·∫ßu ti√™n:</p>
        <ul class="list-disc pl-5 text-left">
          {% for f in formats %}
            <li>{{ f['format_id'] }} - {{ f['ext'] }} - {{ f.get('height', '?') }}p - {{ f['format_note'] }}</li>
          {% endfor %}
        </ul>
        <p class="mt-2 text-xs text-gray-300">(Ch·ªâ hi·ªÉn th·ªã cho video ƒë·∫ßu ti√™n)</p>
      </div>
    {% endif %}
    {% if message %}
      <div class="w-full bg-green-200 border border-green-400 text-green-900 px-4 py-2 rounded mb-4 text-sm">
        {{ message }}
      </div>
    {% endif %}

    <form method="post" class="flex flex-col items-center">
      <textarea name="urls" rows="5" placeholder="D√°n nhi·ªÅu li√™n k·∫øt video t·ª´ YouTube, TikTok, Facebook...&#10;M·ªói d√≤ng m·ªôt li√™n k·∫øt"
             class="w-full px-4 py-2 rounded-md border border-gray-600 bg-gray-800 text-white mb-4 focus:outline-none focus:ring-2 focus:ring-cyan-400"
             required>{{ request.form.get('urls', '') }}</textarea>

      <select name="format"
              class="w-full px-4 py-2 rounded-md border border-gray-600 bg-gray-800 text-white mb-4 focus:outline-none focus:ring-2 focus:ring-cyan-400">
        <option value="mp4" {% if request.form.get('format') == 'mp4' %}selected{% endif %}>üé¨ T·∫£i video (MP4)</option>
        <option value="mp3" {% if request.form.get('format') == 'mp3' %}selected{% endif %}>üéµ T·∫£i √¢m thanh (MP3)</option>
      </select>

      <select name="resolution"
              class="w-full px-4 py-2 rounded-md border border-gray-600 bg-gray-800 text-white mb-6 focus:outline-none focus:ring-2 focus:ring-cyan-400">
        <option value="best">üî∫ T·ªët nh·∫•t</option>
        <option value="720">HD 720p</option>
        <option value="480">SD 480p</option>
        <option value="360">SD 360p</option>
        <option value="240">Th·∫•p 240p</option>
      </select>

      <div class="flex gap-4">
        <button type="submit"
                class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-6 rounded-xl transition-all">
          üì• B·∫Øt ƒë·∫ßu t·∫£i
        </button>
        <a href="/pause" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl">‚è∏ D·ª´ng</a>
        <a href="/resume" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-xl">‚ñ∂ Ti·∫øp t·ª•c</a>
      </div>
    </form>
  </div>
  <p class="mt-6 text-sm text-gray-300 italic">Ngduc T√¢n (Sew)</p>
</body>
</html>
'''

def download_video(url, format_type, resolution):
    filename = str(uuid.uuid4())
    output_template = os.path.join(DOWNLOAD_FOLDER, f"{filename}.%(ext)s")
    options = {
        'outtmpl': output_template,
        'quiet': True,
        'writesubtitles': True,
        'subtitleslangs': ['vi', 'en'],
        'writeautomaticsub': True
    }
    if format_type == 'mp3':
        options['format'] = 'bestaudio/best'
        options['postprocessors'] = [{
            'key': 'FFmpegExtractAudio',
            'preferredcodec': 'mp3',
            'preferredquality': '192',
        }]
    else:
        if resolution == 'best':
            options['format'] = 'bestvideo+bestaudio/best'
        else:
            options['format'] = f"bestvideo[height<={resolution}]+bestaudio/best"
        options['merge_output_format'] = 'mp4'

    try:
        with yt_dlp.YoutubeDL(options) as ydl:
            ydl.download([url])
        return True, filename
    except Exception:
        return False, None

@app.route('/', methods=['GET', 'POST'])
def index():
    global download_paused
    message = ""
    formats = []

    if request.method == 'POST':
        if download_paused:
            message = "‚ö†Ô∏è Qu√° tr√¨nh t·∫£i ƒëang b·ªã t·∫°m d·ª´ng. Vui l√≤ng nh·∫•n Ti·∫øp t·ª•c ƒë·ªÉ ti·∫øp t·ª•c t·∫£i."
        else:
            urls = request.form['urls'].strip().splitlines()
            format_type = request.form['format']
            resolution = request.form.get('resolution', 'best')
            downloaded_files = []

            if urls:
                try:
                    with yt_dlp.YoutubeDL({'quiet': True}) as ydl:
                        info = ydl.extract_info(urls[0], download=False)
                        formats = [f for f in info.get('formats', []) if f.get('vcodec') != 'none']
                except Exception:
                    formats = []

            success, fail = 0, 0
            with concurrent.futures.ThreadPoolExecutor(max_workers=5) as executor:
                futures = [executor.submit(download_video, url, format_type, resolution) for url in urls]
                for future in concurrent.futures.as_completed(futures):
                    ok, file_id = future.result()
                    if ok:
                        for f in os.listdir(DOWNLOAD_FOLDER):
                            if file_id in f:
                                downloaded_files.append(os.path.join(DOWNLOAD_FOLDER, f))
                        success += 1
                    else:
                        fail += 1

            if downloaded_files:
                zip_name = f"downloads_{uuid.uuid4().hex[:8]}.zip"
                zip_path = os.path.join(DOWNLOAD_FOLDER, zip_name)
                with zipfile.ZipFile(zip_path, 'w') as zipf:
                    for file_path in downloaded_files:
                        zipf.write(file_path, arcname=os.path.basename(file_path))
                return send_from_directory(DOWNLOAD_FOLDER, zip_name, as_attachment=True)

            message = f"T·∫£i xong: {success} th√†nh c√¥ng, {fail} th·∫•t b·∫°i. C√°c t·ªáp ƒë∆∞·ª£c l∆∞u trong th∆∞ m·ª•c 'downloads'."

    return render_template_string(HTML_TEMPLATE, message=message, formats=formats)

@app.route('/pause')
def pause():
    global download_paused
    download_paused = True
    return redirect(url_for('index'))

@app.route('/resume')
def resume():
    global download_paused
    download_paused = False
    return redirect(url_for('index'))

if __name__ == '__main__':
    app.run(debug=True)
